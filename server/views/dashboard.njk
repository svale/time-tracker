{% extends "layouts/main.njk" %}

{% block title %}Time Tracker - Dashboard{% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
            <!-- Date Navigation -->
            <nav class="date-nav" id="date-nav">
                <button class="date-nav-arrow" id="prev-day" title="Previous day">&larr;</button>
                <button class="date-nav-arrow" id="next-day" title="Next day">&rarr;</button>
                <div class="date-nav-tabs" id="date-tabs">
                    <!-- Populated by JavaScript -->
                </div>
                <button class="date-nav-today" id="today-btn">Today</button>
                <input type="date" class="date-nav-picker" id="date-picker" title="Jump to date">
            </nav>

            <!-- Workday Summary Bar -->
            <div class="workday-bar" id="workday-bar">
                <span class="workday-times" id="workday-times">‚Äî</span>
                <span class="workday-separator">&bull;</span>
                <span class="workday-total" id="workday-total">Loading...</span>
            </div>

            <!-- Project Breakdown -->
            <section class="project-breakdown-section">
                <div id="project-breakdown">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>Loading projects...</p>
                    </div>
                </div>
            </section>

            <!-- Timeline visualization -->
            <section class="timeline-section">
                <h2 class="section-title-small">Hourly Timeline</h2>
                <div class="chart-container">
                    <canvas id="timeline-chart"></canvas>
                </div>
            </section>

            <!-- Detail Tabs -->
            <section class="detail-tabs-section">
                <div class="detail-tabs">
                    <button class="detail-tab active" data-tab="calendar">Calendar Events</button>
                    <button class="detail-tab" data-tab="git">Git Activity</button>
                    <button class="detail-tab" data-tab="domains">Domain List</button>
                </div>

                <!-- Calendar Events Tab -->
                <div class="detail-content" id="tab-calendar">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>Loading calendar events...</p>
                    </div>
                </div>

                <!-- Git Activity Tab -->
                <div class="detail-content hidden" id="tab-git">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>Loading git activity...</p>
                    </div>
                </div>

                <!-- Domain List Tab -->
                <div class="detail-content hidden" id="tab-domains">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>Loading domains...</p>
                    </div>
                </div>
            </section>
{% endblock %}

{% block scripts %}
    <script>
        // ===================================
        // State
        // ===================================
        let currentDate = new Date();
        let windowStartDate = new Date(); // Start of the 7-day window
        let timelineChart = null;

        // ===================================
        // Date Navigation
        // ===================================

        function getDateString(date) {
            // Use local date components to avoid timezone issues
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function getWindowDays() {
            const days = [];
            const start = new Date(windowStartDate);
            for (let i = 0; i < 7; i++) {
                const day = new Date(start);
                day.setDate(start.getDate() + i);
                days.push(day);
            }
            return days;
        }

        function renderDateTabs() {
            const container = document.getElementById('date-tabs');
            const days = getWindowDays();
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            let html = '';
            days.forEach((day) => {
                const dateStr = getDateString(day);
                const isActive = dateStr === getDateString(currentDate);

                // Unified label format for all days
                const dayName = dayNames[day.getDay()];
                const dayNum = day.getDate();
                const month = day.getMonth() + 1;
                const label = `${dayName} ${dayNum}/${month}`;

                const isFuture = day > new Date();

                html += `
                    <button class="date-tab ${isActive ? 'active' : ''} ${isFuture ? 'future' : ''}"
                            data-date="${dateStr}"
                            ${isFuture ? 'disabled' : ''}>
                        ${label}
                    </button>
                `;
            });

            container.innerHTML = html;

            // Add click handlers
            container.querySelectorAll('.date-tab:not([disabled])').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Parse date components directly to avoid timezone issues
                    const [year, month, day] = tab.dataset.date.split('-').map(Number);
                    currentDate = new Date(year, month - 1, day);
                    updateURL();
                    renderDateTabs();
                    loadAllData();
                });
            });
        }

        function updateURL() {
            const url = new URL(window.location);
            url.searchParams.set('date', getDateString(currentDate));
            window.history.replaceState({}, '', url);
        }

        function ensureDateVisible() {
            const windowEnd = new Date(windowStartDate);
            windowEnd.setDate(windowEnd.getDate() + 6);

            if (currentDate < windowStartDate || currentDate > windowEnd) {
                // Center window on current date
                windowStartDate = new Date(currentDate);
                windowStartDate.setDate(windowStartDate.getDate() - 3);
            }
        }

        document.getElementById('prev-day').addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() - 1);
            ensureDateVisible();
            updateURL();
            renderDateTabs();
            loadAllData();
        });

        document.getElementById('next-day').addEventListener('click', () => {
            const today = new Date();
            const tomorrow = new Date(currentDate);
            tomorrow.setDate(tomorrow.getDate() + 1);

            // Only allow if not going into the future
            if (tomorrow <= today) {
                currentDate.setDate(currentDate.getDate() + 1);
                ensureDateVisible();
                updateURL();
                renderDateTabs();
                loadAllData();
            }
        });

        document.getElementById('today-btn').addEventListener('click', () => {
            currentDate = new Date();
            // Center window on today
            windowStartDate = new Date();
            windowStartDate.setDate(windowStartDate.getDate() - 3);
            updateURL();
            renderDateTabs();
            loadAllData();
        });

        document.getElementById('date-picker').addEventListener('change', (e) => {
            // Parse date components directly to avoid timezone issues
            const [year, month, day] = e.target.value.split('-').map(Number);
            const selectedDate = new Date(year, month - 1, day);
            const today = new Date();

            if (selectedDate <= today) {
                currentDate = selectedDate;
                // Center window around selected date
                windowStartDate = new Date(selectedDate);
                windowStartDate.setDate(windowStartDate.getDate() - 3);
                updateURL();
                renderDateTabs();
                loadAllData();
            }
        });

        // ===================================
        // Tab Switching
        // ===================================

        document.querySelectorAll('.detail-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Update active tab
                document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Show/hide content
                document.querySelectorAll('.detail-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`tab-${tab.dataset.tab}`).classList.remove('hidden');
            });
        });

        // ===================================
        // Helper Functions
        // ===================================

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function truncate(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // ===================================
        // Workday Summary Bar
        // ===================================

        async function loadWorkdaySummary() {
            const dateStr = getDateString(currentDate);
            try {
                const response = await fetch(`/api/workday-stats?date=${dateStr}`);
                const data = await response.json();

                const timesEl = document.getElementById('workday-times');
                const totalEl = document.getElementById('workday-total');

                if (data.has_sufficient_data) {
                    timesEl.textContent = `${data.workday_start_formatted} - ${data.workday_end_formatted}`;
                    totalEl.textContent = `${data.total_time} total`;
                } else {
                    timesEl.textContent = 'No activity';
                    totalEl.textContent = '0m';
                }
            } catch (error) {
                console.error('Error loading workday summary:', error);
            }
        }

        // ===================================
        // Project Breakdown
        // ===================================

        async function loadProjectBreakdown() {
            const container = document.getElementById('project-breakdown');
            const dateStr = getDateString(currentDate);

            try {
                const response = await fetch(`/api/project-summary?date=${dateStr}`);
                const data = await response.json();

                if (data.projects.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p class="empty-message">No activity recorded for this day.</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                data.projects.forEach(project => {
                    // Build domain list
                    const domainList = project.domains.slice(0, 3)
                        .map(d => `${escapeHtml(d.domain)} (${d.time})`)
                        .join(', ');

                    // Build calendar list
                    const calendarList = project.calendar_events.slice(0, 2)
                        .map(e => `${escapeHtml(truncate(e.title, 30))} (${e.duration})`)
                        .join(', ');

                    html += `
                        <div class="project-card">
                            <div class="project-header">
                                <div class="project-name-row">
                                    <span class="project-color-dot" style="background: ${project.project_color}"></span>
                                    <span class="project-name">${escapeHtml(project.project_name)}</span>
                                </div>
                                <span class="project-time">${project.total_time}</span>
                            </div>
                            <div class="project-bar-container">
                                <div class="project-bar" style="width: ${project.percentage}%; background: ${project.project_color}"></div>
                            </div>
                            <div class="project-details">
                                ${domainList ? `<div class="detail-row"><span class="detail-icon">üìÑ</span> ${domainList}</div>` : ''}
                                ${calendarList ? `<div class="detail-row"><span class="detail-icon">üìÖ</span> ${calendarList}</div>` : ''}
                                ${project.git_commits > 0 ? `<div class="detail-row"><span class="detail-icon">üíæ</span> ${project.git_commits} commit${project.git_commits !== 1 ? 's' : ''}</div>` : ''}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading project breakdown:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <p class="empty-message">Failed to load projects.</p>
                    </div>
                `;
            }
        }

        // ===================================
        // Stacked Timeline Chart
        // ===================================

        async function loadTimelineChart() {
            const ctx = document.getElementById('timeline-chart').getContext('2d');
            const dateStr = getDateString(currentDate);

            try {
                const response = await fetch(`/api/timeline?date=${dateStr}`);
                const data = await response.json();

                // Build datasets per project
                const projectDatasets = {};
                data.timeline.forEach((hour, hourIndex) => {
                    if (hour.by_project) {
                        hour.by_project.forEach(p => {
                            const key = p.project_id || 'unassigned';
                            if (!projectDatasets[key]) {
                                projectDatasets[key] = {
                                    label: p.project_name,
                                    data: Array(24).fill(0),
                                    backgroundColor: p.project_color,
                                    borderRadius: 2
                                };
                            }
                            projectDatasets[key].data[hourIndex] = Math.round(p.seconds / 60);
                        });
                    }
                });

                const datasets = Object.values(projectDatasets);
                const labels = data.timeline.map(h => h.hour);

                if (timelineChart) {
                    timelineChart.destroy();
                }

                timelineChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                                grid: { display: false },
                                ticks: {
                                    maxRotation: 0,
                                    callback: function(val, index) {
                                        return index % 3 === 0 ? this.getLabelForValue(val) : '';
                                    }
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                title: { display: true, text: 'Minutes' },
                                grid: { color: 'rgba(0,0,0,0.05)' }
                            }
                        },
                        plugins: {
                            legend: {
                                display: datasets.length > 1,
                                position: 'bottom',
                                labels: { boxWidth: 12, padding: 15 }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading timeline:', error);
            }
        }

        // ===================================
        // Calendar Events Tab
        // ===================================

        async function loadCalendarEvents() {
            const container = document.getElementById('tab-calendar');
            const dateStr = getDateString(currentDate);

            try {
                const response = await fetch(`/api/calendar-events?date=${dateStr}`);
                const data = await response.json();

                if (data.events.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p class="empty-message">No calendar events for this day.</p>
                            <p class="empty-hint">Add calendar subscriptions in <a href="/settings">Settings</a></p>
                        </div>
                    `;
                    return;
                }

                let html = '<div class="detail-list">';
                data.events.forEach(event => {
                    const startTime = new Date(event.start_time).toLocaleTimeString('en-US', {
                        hour: '2-digit', minute: '2-digit', hour12: true
                    });
                    const endTime = new Date(event.end_time).toLocaleTimeString('en-US', {
                        hour: '2-digit', minute: '2-digit', hour12: true
                    });

                    html += `
                        <div class="detail-item">
                            <div class="detail-item-main">
                                <span class="detail-item-title">üìÖ ${escapeHtml(event.title)}</span>
                                ${event.project_name ? `<span class="project-badge" style="background: ${event.project_color}">${escapeHtml(event.project_name)}</span>` : ''}
                            </div>
                            <div class="detail-item-meta">${startTime} - ${endTime} (${event.duration})</div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading calendar events:', error);
            }
        }

        // ===================================
        // Git Activity Tab
        // ===================================

        async function loadGitActivity() {
            const container = document.getElementById('tab-git');
            const dateStr = getDateString(currentDate);

            try {
                const response = await fetch(`/api/git-activity?date=${dateStr}`);
                const data = await response.json();

                if (data.activities.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p class="empty-message">No git activity for this day.</p>
                        </div>
                    `;
                    return;
                }

                const icons = { commit: 'üíæ', merge: 'üîÄ', branch: 'üåø' };
                let html = '<div class="detail-list">';
                data.activities.forEach(activity => {
                    const time = new Date(activity.timestamp).toLocaleTimeString('en-US', {
                        hour: '2-digit', minute: '2-digit', hour12: true
                    });
                    const icon = icons[activity.action_type] || 'üìù';

                    html += `
                        <div class="detail-item">
                            <div class="detail-item-main">
                                <span class="detail-item-title">${icon} ${escapeHtml(activity.repo_name)}</span>
                                ${activity.project_name ? `<span class="project-badge" style="background: ${activity.project_color}">${escapeHtml(activity.project_name)}</span>` : ''}
                            </div>
                            <div class="detail-item-meta">
                                ${activity.commit_message ? escapeHtml(truncate(activity.commit_message, 50)) : activity.action_type}
                                <span class="detail-item-time">${time}</span>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading git activity:', error);
            }
        }

        // ===================================
        // Domain List Tab
        // ===================================

        async function loadDomainList() {
            const container = document.getElementById('tab-domains');
            const dateStr = getDateString(currentDate);

            try {
                const response = await fetch(`/api/daily-report?date=${dateStr}`);
                const data = await response.json();

                if (data.activities.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p class="empty-message">No domain activity for this day.</p>
                        </div>
                    `;
                    return;
                }

                let html = '<div class="detail-list">';
                data.activities.forEach(activity => {
                    const displayName = activity.domain || activity.app_name;

                    html += `
                        <div class="detail-item">
                            <div class="detail-item-main">
                                <span class="detail-item-title">üìÑ ${escapeHtml(displayName)}</span>
                                ${activity.project_name ? `<span class="project-badge" style="background: ${activity.project_color}">${escapeHtml(activity.project_name)}</span>` : ''}
                            </div>
                            <div class="detail-item-meta">
                                ${activity.time} (${activity.session_count} session${activity.session_count !== 1 ? 's' : ''})
                                <span class="detail-item-percent">${activity.percentage}%</span>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading domain list:', error);
            }
        }

        // ===================================
        // Load All Data
        // ===================================

        function loadAllData() {
            loadWorkdaySummary();
            loadProjectBreakdown();
            loadTimelineChart();
            loadCalendarEvents();
            loadGitActivity();
            loadDomainList();
        }

        // ===================================
        // Initialize
        // ===================================

        // Check URL for date parameter
        const urlParams = new URLSearchParams(window.location.search);
        const dateParam = urlParams.get('date');

        if (dateParam && /^\d{4}-\d{2}-\d{2}$/.test(dateParam)) {
            // Parse date components directly to avoid timezone issues
            const [year, month, day] = dateParam.split('-').map(Number);
            currentDate = new Date(year, month - 1, day);
            // Don't allow future dates
            if (currentDate > new Date()) {
                currentDate = new Date();
            }
        } else {
            currentDate = new Date();
        }

        // Center window on selected date
        windowStartDate = new Date(currentDate);
        windowStartDate.setDate(windowStartDate.getDate() - 3);

        renderDateTabs();
        loadAllData();

        // Refresh data every 60 seconds
        setInterval(loadAllData, 60000);
    </script>
{% endblock %}
