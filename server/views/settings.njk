{% extends "layouts/main.njk" %}

{% block title %}Time Tracker - Settings{% endblock %}

{% block content %}
            <!-- Decorative separator -->
            <div class="section-separator">
                <span class="separator-ornament">‚óÜ</span>
            </div>

            <section class="summary-section">
                <div class="section-header">
                    <h2 class="section-title">Configuration</h2>
                    <p class="section-description">Customize your time tracking preferences</p>
                </div>

                <!-- Tracking Settings -->
                <div class="activities-container settings-form-section">
                    <h3 class="settings-form-title">
                        Tracking Settings
                    </h3>
                    <form id="settings-form">
                        <div class="form-group">
                            <label for="polling_interval">Polling Interval (minutes)</label>
                            <input type="number"
                                   id="polling_interval"
                                   name="polling_interval_minutes"
                                   min="1"
                                   max="60"
                                   value="5"
                                   placeholder="5">
                            <p class="settings-form-help">
                                How often to check browser history (default: 5 minutes). Requires daemon restart to take effect.
                            </p>
                        </div>

                        <div class="form-group">
                            <label for="session_gap">Session Gap (minutes)</label>
                            <input type="number"
                                   id="session_gap"
                                   name="session_gap_minutes"
                                   min="1"
                                   max="30"
                                   value="5"
                                   placeholder="5">
                            <p class="settings-form-help">
                                Time between visits to consider them separate sessions (default: 5 minutes)
                            </p>
                        </div>

                        <div class="settings-form-actions">
                            <button type="submit">Save Settings</button>
                            <div id="save-message" class="settings-message"></div>
                        </div>
                    </form>
                </div>

                <!-- Focus Tracking Settings -->
                <div class="activities-container settings-form-section">
                    <h3 class="settings-form-title">
                        Focus Tracking
                    </h3>
                    <p class="section-description mb-3">
                        Track when your browser is actually focused to get more accurate time measurements. Time only counts when the browser window is active.
                    </p>
                    <form id="focus-settings-form">
                        <div class="form-group">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox"
                                       id="focus_tracking_enabled"
                                       style="margin-right: 8px;">
                                Enable Focus Tracking
                            </label>
                            <p class="settings-form-help">
                                When enabled, time only counts when the browser is the active application and focused on a tracked domain.
                            </p>
                        </div>

                        <div class="form-group">
                            <label for="focus_poll_interval">Poll Interval (seconds)</label>
                            <select id="focus_poll_interval" style="width: auto; padding: 8px 16px;">
                                <option value="15">15 seconds</option>
                                <option value="30">30 seconds (default)</option>
                                <option value="60">60 seconds</option>
                            </select>
                            <p class="settings-form-help">
                                How often to check if browser is focused. Lower values are more accurate but use more resources.
                            </p>
                        </div>

                        <div class="form-group">
                            <label for="max_session_duration">Max Session Duration (minutes)</label>
                            <select id="max_session_duration" style="width: auto; padding: 8px 16px;">
                                <option value="15">15 minutes</option>
                                <option value="30">30 minutes (default)</option>
                                <option value="60">60 minutes</option>
                            </select>
                            <p class="settings-form-help">
                                Maximum duration for a single session. Sessions longer than this will be capped, preventing over-counting from leaving a tab open.
                            </p>
                        </div>

                        <div class="settings-form-actions">
                            <button type="submit">Save Focus Settings</button>
                            <div id="focus-save-message" class="settings-message"></div>
                        </div>
                    </form>
                </div>

                <!-- Calendar Subscriptions -->
                <div class="activities-container settings-form-section">
                    <h3 class="settings-form-title mb-2">
                        Calendar Subscriptions
                    </h3>
                    <p class="section-description mb-3">
                        Track calendar events from Google, Outlook, Apple Calendar, or any iCal-compatible calendar.
                    </p>

                    <!-- Add Calendar Form -->
                    <div id="add-calendar-form" class="calendar-card">
                        <h4 class="calendar-card-title mb-2">
                            Add Calendar
                        </h4>
                        <form id="calendar-form">
                            <div class="form-group">
                                <label for="calendar-name">Calendar Name</label>
                                <input type="text"
                                       id="calendar-name"
                                       placeholder="e.g., Work Calendar, Personal"
                                       required>
                            </div>
                            <div class="form-group">
                                <label for="calendar-url">iCal Feed URL</label>
                                <input type="url"
                                       id="calendar-url"
                                       placeholder="https://calendar.google.com/calendar/ical/..."
                                       required>
                                <details style="margin-top: 12px;">
                                    <summary style="cursor: pointer; color: var(--color-terracotta); font-size: 0.9rem; user-select: none;">
                                        How to get your iCal URL
                                    </summary>
                                    <div style="margin-top: 12px; padding-left: 16px; border-left: 3px solid var(--color-border); color: var(--color-warm-gray); font-size: 0.85rem; line-height: 1.6;">
                                        <p style="margin-bottom: 8px;"><strong>Google Calendar:</strong></p>
                                        <ol style="margin-left: 16px; margin-bottom: 12px;">
                                            <li>Open Google Calendar</li>
                                            <li>Click ‚ãÆ next to your calendar ‚Üí Settings</li>
                                            <li>Scroll to "Integrate calendar"</li>
                                            <li>Copy the "Secret address in iCal format"</li>
                                        </ol>
                                        <p style="margin-bottom: 8px;"><strong>Outlook/Microsoft 365:</strong></p>
                                        <ol style="margin-left: 16px; margin-bottom: 12px;">
                                            <li>Open Outlook Calendar</li>
                                            <li>Settings ‚Üí View all Outlook settings ‚Üí Calendar ‚Üí Shared calendars</li>
                                            <li>Publish calendar ‚Üí Copy ICS link</li>
                                        </ol>
                                        <p style="margin-bottom: 8px;"><strong>Apple Calendar (iCloud):</strong></p>
                                        <ol style="margin-left: 16px;">
                                            <li>Open iCloud.com ‚Üí Calendar</li>
                                            <li>Click share icon next to calendar</li>
                                            <li>Enable "Public Calendar" ‚Üí Copy link</li>
                                        </ol>
                                    </div>
                                </details>
                            </div>
                            <div class="settings-form-actions">
                                <button type="submit">Add Calendar</button>
                                <div id="calendar-message" class="settings-message"></div>
                            </div>
                        </form>
                    </div>

                    <!-- Calendar List -->
                    <div id="calendar-list">
                        <div class="loading-state">
                            Loading calendars...
                        </div>
                    </div>
                </div>

                <!-- Git Repositories -->
                <div class="activities-container settings-form-section">
                    <h3 class="settings-form-title mb-2">
                        Git Repositories
                    </h3>
                    <p class="section-description mb-3">
                        Track local git activity (commits, merges, branches). The daemon scans for repositories in common locations and monitors their activity.
                    </p>

                    <!-- Git Repository List -->
                    <div id="git-repo-list">
                        <div class="loading-state">
                            Loading repositories...
                        </div>
                    </div>
                </div>

                <!-- Chrome Profiles -->
                <div class="activities-container settings-form-section">
                    <h3 class="settings-form-title mb-2">
                        Chrome Profiles
                    </h3>
                    <p class="section-description mb-3">
                        Select which Chrome profiles to track. Enable work profiles and disable personal profiles.
                    </p>

                    <div id="chrome-profile-list">
                        <div class="loading-state">
                            Loading Chrome profiles...
                        </div>
                    </div>
                </div>

                <!-- Database Info -->
                <div class="activities-container settings-form-section">
                    <h3 class="settings-form-title">
                        Database Information
                    </h3>
                    <p class="section-description mb-2">
                        Database location:
                        <code class="form-input" style="display: inline; width: auto; padding: 6px 12px; font-size: 0.85rem;">
                            data/activity.db
                        </code>
                    </p>
                    <p class="section-description">
                        All your activity data is stored locally on your computer in a SQLite database. No data is sent to external servers.
                    </p>
                </div>

                <!-- Privacy Information -->
                <div class="activities-container">
                    <h3 class="settings-form-title">
                        Privacy Principles
                    </h3>
                    <ul class="section-description" style="margin-left: 24px; line-height: 2;">
                        <li>All data stays on your machine ‚Äî nothing is transmitted over the network</li>
                        <li>No telemetry, analytics, or tracking of any kind</li>
                        <li>Only reads browser history files (Chrome and Safari)</li>
                        <li>No accessibility permissions required (unlike traditional time trackers)</li>
                        <li>You can delete the database file at any time without consequences</li>
                        <li>Open source ‚Äî inspect the code yourself</li>
                    </ul>
                </div>
            </section>

    <!-- Create Project Modal -->
    <div id="create-project-modal" class="modal-overlay">
        <div class="modal">
            <h3 class="modal-title">Create Project from Repository</h3>
            <form id="create-project-form">
                <input type="hidden" id="create-project-repo-id" value="">

                <div class="form-group">
                    <label class="form-label" for="create-project-name">Project Name</label>
                    <input type="text" id="create-project-name" class="form-input" required placeholder="e.g., Work, Personal, Learning">
                </div>

                <div class="form-group">
                    <label class="form-label" for="create-project-description">Description (optional)</label>
                    <input type="text" id="create-project-description" class="form-input" placeholder="Brief description of this project">
                </div>

                <div class="form-group">
                    <label class="form-label" for="create-project-color">Color</label>
                    <input type="color" id="create-project-color" class="form-input color-input" value="#3B82F6">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeCreateProjectModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Project</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}

    <script>
        // Load current settings
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();

                document.getElementById('polling_interval').value = settings.polling_interval_minutes || 5;
                document.getElementById('session_gap').value = settings.session_gap_minutes || 5;
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Save settings
        document.getElementById('settings-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                polling_interval_minutes: parseInt(document.getElementById('polling_interval').value),
                session_gap_minutes: parseInt(document.getElementById('session_gap').value)
            };

            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const messageEl = document.getElementById('save-message');
                    messageEl.textContent = '‚úì Settings saved successfully!';
                    setTimeout(() => {
                        messageEl.textContent = '';
                    }, 3000);
                } else {
                    alert('Failed to save settings');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Failed to save settings');
            }
        });

        // Load settings on page load
        loadSettings();

        // ===================================
        // Focus Tracking Settings
        // ===================================

        // Load focus settings
        async function loadFocusSettings() {
            try {
                const response = await fetch('/api/settings/focus');
                const settings = await response.json();

                document.getElementById('focus_tracking_enabled').checked = settings.focus_tracking_enabled;
                document.getElementById('focus_poll_interval').value = settings.focus_poll_interval_seconds || 30;
                document.getElementById('max_session_duration').value = settings.max_session_duration_minutes || 30;
            } catch (error) {
                console.error('Error loading focus settings:', error);
            }
        }

        // Save focus settings
        document.getElementById('focus-settings-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                focus_tracking_enabled: document.getElementById('focus_tracking_enabled').checked,
                focus_poll_interval_seconds: parseInt(document.getElementById('focus_poll_interval').value),
                max_session_duration_minutes: parseInt(document.getElementById('max_session_duration').value)
            };

            try {
                const response = await fetch('/api/settings/focus', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const messageEl = document.getElementById('focus-save-message');
                    messageEl.textContent = '‚úì Focus settings saved! Restart daemon to apply changes.';
                    setTimeout(() => {
                        messageEl.textContent = '';
                    }, 5000);
                } else {
                    alert('Failed to save focus settings');
                }
            } catch (error) {
                console.error('Error saving focus settings:', error);
                alert('Failed to save focus settings');
            }
        });

        // Load focus settings on page load
        loadFocusSettings();

        // ===================================
        // Calendar Subscription Management
        // ===================================

        let calendars = [];

        // Load calendar subscriptions
        async function loadCalendars() {
            try {
                const response = await fetch('/api/integrations/calendars');
                calendars = await response.json();
                renderCalendars();
            } catch (error) {
                console.error('Error loading calendars:', error);
                document.getElementById('calendar-list').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--color-warm-gray); font-style: italic;">
                        Failed to load calendars
                    </div>
                `;
            }
        }

        // Render calendar list
        function renderCalendars() {
            const container = document.getElementById('calendar-list');

            if (calendars.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p class="empty-message">No calendars added yet.</p>
                        <p class="empty-hint">Add your first calendar above.</p>
                    </div>
                `;
                return;
            }

            const html = calendars.map(cal => {
                const providerIcon = {
                    'google': 'üóìÔ∏è',
                    'outlook': 'üìÖ',
                    'apple': 'üìÜ',
                    'other': 'üìã'
                }[cal.provider] || 'üìã';

                const lastSyncText = cal.last_sync ?
                    new Date(cal.last_sync).toLocaleString() : 'Never';

                const statusColor = cal.is_active ? 'var(--color-success)' : 'var(--color-warm-gray)';
                const statusText = cal.is_active ? 'Active' : 'Inactive';

                // Button styling
                const toggleBtnClass = cal.is_active ? 'btn' : 'btn btn-primary';
                const toggleBtnStyle = cal.is_active
                    ? 'background: var(--color-warm-gray); color: white; border-color: var(--color-warm-gray);'
                    : 'background: var(--color-success); color: white; border-color: var(--color-success);';
                const toggleBtnText = cal.is_active ? 'Pause' : 'Activate';

                return `
                    <div class="calendar-card">
                        <div class="calendar-card-header">
                            <div>
                                <h4 class="calendar-card-title">
                                    ${providerIcon} ${cal.name}
                                </h4>
                                <div class="calendar-card-meta">
                                    Provider: ${cal.provider.charAt(0).toUpperCase() + cal.provider.slice(1)}
                                    <span style="margin: 0 8px;">‚Ä¢</span>
                                    <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span>
                                </div>
                                <div class="calendar-card-meta">
                                    Last sync: ${lastSyncText}
                                </div>
                                <label class="calendar-worktime-toggle">
                                    <input type="checkbox"
                                           ${cal.include_in_worktime ? 'checked' : ''}
                                           onchange="toggleCalendarWorktime(${cal.id}, this.checked)">
                                    Include in work time
                                </label>
                                ${cal.last_error ? `
                                    <div class="calendar-card-error">
                                        ‚ö† Error: ${cal.last_error}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="calendar-card-actions">
                                <button onclick="toggleCalendar(${cal.id}, ${!cal.is_active})"
                                        class="${toggleBtnClass}" style="${toggleBtnStyle} padding: 8px 16px; font-size: 0.85rem;">
                                    ${toggleBtnText}
                                </button>
                                <button onclick="syncCalendar(${cal.id})"
                                        class="btn" style="background: var(--color-charcoal); color: white; border-color: var(--color-charcoal); padding: 8px 16px; font-size: 0.85rem;">
                                    Sync Now
                                </button>
                                <button onclick="deleteCalendar(${cal.id})"
                                        class="btn btn-danger" style="padding: 8px 16px; font-size: 0.85rem;">
                                    Remove
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Add calendar
        document.getElementById('calendar-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const name = document.getElementById('calendar-name').value.trim();
            const ical_url = document.getElementById('calendar-url').value.trim();

            const messageEl = document.getElementById('calendar-message');
            messageEl.textContent = 'Adding calendar...';

            try {
                const response = await fetch('/api/integrations/calendars', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, ical_url })
                });

                if (response.ok) {
                    messageEl.textContent = '‚úì Calendar added successfully!';
                    document.getElementById('calendar-form').reset();
                    setTimeout(() => {
                        messageEl.textContent = '';
                    }, 3000);
                    await loadCalendars();
                } else {
                    const error = await response.json();
                    messageEl.textContent = '‚úó ' + (error.error || 'Failed to add calendar');
                    messageEl.style.color = 'var(--color-terracotta)';
                }
            } catch (error) {
                console.error('Error adding calendar:', error);
                messageEl.textContent = '‚úó Failed to add calendar';
                messageEl.style.color = 'var(--color-terracotta)';
            }
        });

        // Toggle calendar worktime setting
        async function toggleCalendarWorktime(calendarId, includeInWorktime) {
            try {
                await fetch(`/api/calendar-subscriptions/${calendarId}/worktime`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ include_in_worktime: includeInWorktime })
                });
            } catch (error) {
                console.error('Error updating calendar worktime setting:', error);
            }
        }

        // Toggle calendar active status
        async function toggleCalendar(id, isActive) {
            try {
                const response = await fetch(`/api/integrations/calendars/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: isActive })
                });

                if (response.ok) {
                    await loadCalendars();
                } else {
                    alert('Failed to update calendar');
                }
            } catch (error) {
                console.error('Error toggling calendar:', error);
                alert('Failed to update calendar');
            }
        }

        // Sync calendar manually
        async function syncCalendar(id) {
            try {
                const response = await fetch(`/api/integrations/calendars/${id}/sync`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('Calendar sync triggered! Check back in a moment.');
                    setTimeout(loadCalendars, 2000);
                } else {
                    alert('Failed to sync calendar');
                }
            } catch (error) {
                console.error('Error syncing calendar:', error);
                alert('Failed to sync calendar');
            }
        }

        // Delete calendar
        async function deleteCalendar(id) {
            if (!confirm('Are you sure you want to remove this calendar? All associated events will be deleted.')) {
                return;
            }

            try {
                const response = await fetch(`/api/integrations/calendars/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadCalendars();
                } else {
                    alert('Failed to remove calendar');
                }
            } catch (error) {
                console.error('Error deleting calendar:', error);
                alert('Failed to remove calendar');
            }
        }

        // Load calendars on page load
        loadCalendars();

        // ===================================
        // Git Repository Management
        // ===================================

        let gitRepos = [];

        // Load git repositories
        async function loadGitRepos() {
            try {
                const response = await fetch('/api/git-repositories');
                gitRepos = await response.json();
                renderGitRepos();
            } catch (error) {
                console.error('Error loading git repositories:', error);
                document.getElementById('git-repo-list').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--color-warm-gray); font-style: italic;">
                        Failed to load git repositories
                    </div>
                `;
            }
        }

        // Render git repositories
        function renderGitRepos() {
            const container = document.getElementById('git-repo-list');

            if (gitRepos.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--color-warm-gray); font-style: italic;">
                        No git repositories found yet. The daemon will scan for repositories on next check.
                    </div>
                `;
                return;
            }

            const html = gitRepos.map(repo => `
                <div class="calendar-card" style="position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 class="calendar-card-title" style="margin-bottom: 8px;">
                                ${repo.repo_name}
                                ${repo.project_name ? `<span style="color: ${repo.project_color}; font-size: 0.85rem; font-weight: normal;"> ‚Üí ${repo.project_name}</span>` : ''}
                            </h4>
                            <p style="color: var(--color-warm-gray); font-size: 0.85rem; margin-bottom: 12px; font-family: monospace;">
                                ${repo.repo_path}
                            </p>
                            <div style="display: flex; gap: 12px; margin-bottom: 8px; flex-wrap: wrap; align-items: center;">
                                <label style="display: flex; align-items: center; font-size: 0.9rem;">
                                    <input type="checkbox"
                                           ${repo.is_active ? 'checked' : ''}
                                           onchange="toggleRepo(${repo.id})"
                                           style="margin-right: 6px;">
                                    Active
                                </label>
                                <select onchange="assignRepoToProject(${repo.id}, this.value)"
                                        style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--color-border); background: var(--color-bg); color: var(--color-text); font-size: 0.85rem;">
                                    <option value="">No Project</option>
                                    ${projects.map(p => `
                                        <option value="${p.id}" ${repo.project_id === p.id ? 'selected' : ''}>
                                            ${p.name}
                                        </option>
                                    `).join('')}
                                </select>
                                <button onclick="openCreateProjectModal(${repo.id}, '${repo.repo_name.replace(/'/g, "\\'")}')"
                                        class="btn btn-primary"
                                        style="padding: 4px 12px; font-size: 0.8rem;">
                                    + Create Project
                                </button>
                            </div>
                            ${repo.last_scanned ? `
                                <p style="color: var(--color-warm-gray); font-size: 0.75rem;">
                                    Last scanned: ${new Date(repo.last_scanned).toLocaleString()}
                                </p>
                            ` : ''}
                        </div>
                        <button onclick="deleteRepo(${repo.id})"
                                style="background: none; border: none; color: var(--color-warm-gray); cursor: pointer; padding: 8px; font-size: 1.2rem; line-height: 1;"
                                title="Remove repository">
                            √ó
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // Toggle repository active/inactive
        async function toggleRepo(id) {
            const repo = gitRepos.find(r => r.id === id);
            if (!repo) return;

            try {
                const response = await fetch(`/api/git-repositories/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        is_active: !repo.is_active
                    })
                });

                if (response.ok) {
                    await loadGitRepos();
                } else {
                    alert('Failed to update repository');
                }
            } catch (error) {
                console.error('Error toggling repository:', error);
                alert('Failed to update repository');
            }
        }

        // Assign repository to project
        async function assignRepoToProject(repoId, projectId) {
            try {
                const response = await fetch(`/api/git-repositories/${repoId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        project_id: projectId === '' ? null : parseInt(projectId, 10)
                    })
                });

                if (response.ok) {
                    await loadGitRepos();
                } else {
                    alert('Failed to assign repository to project');
                }
            } catch (error) {
                console.error('Error assigning repository:', error);
                alert('Failed to assign repository to project');
            }
        }

        // Delete repository
        async function deleteRepo(id) {
            if (!confirm('Are you sure you want to stop tracking this repository?')) {
                return;
            }

            try {
                const response = await fetch(`/api/git-repositories/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadGitRepos();
                } else {
                    alert('Failed to remove repository');
                }
            } catch (error) {
                console.error('Error deleting repository:', error);
                alert('Failed to remove repository');
            }
        }

        // Load git repos on page load (and load projects for dropdown)
        let projects = [];
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                projects = await response.json();
                loadGitRepos();
            } catch (error) {
                console.error('Error loading projects:', error);
                loadGitRepos(); // Still load repos even if projects fail
            }
        }
        loadProjects();

        // ===================================
        // Chrome Profile Management
        // ===================================

        let chromeProfiles = [];

        async function loadChromeProfiles() {
            try {
                const response = await fetch('/api/chrome-profiles');
                chromeProfiles = await response.json();
                renderChromeProfiles();
            } catch (error) {
                console.error('Error loading Chrome profiles:', error);
                document.getElementById('chrome-profile-list').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--color-warm-gray); font-style: italic;">
                        Failed to load Chrome profiles
                    </div>
                `;
            }
        }

        function renderChromeProfiles() {
            const container = document.getElementById('chrome-profile-list');

            if (chromeProfiles.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--color-warm-gray); font-style: italic;">
                        No Chrome profiles found. Is Chrome installed?
                    </div>
                `;
                return;
            }

            const html = chromeProfiles.map(profile => `
                <div class="calendar-card" style="padding: 12px 16px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox"
                               ${profile.enabled ? 'checked' : ''}
                               onchange="toggleChromeProfile('${profile.id}')"
                               style="margin-right: 12px;">
                        <div>
                            <span style="font-weight: 500;">${profile.name}</span>
                            ${profile.email ? `<span style="color: var(--color-warm-gray); font-size: 0.85rem; margin-left: 8px;">${profile.email}</span>` : ''}
                            <span style="color: var(--color-warm-gray); font-size: 0.75rem; margin-left: 8px;">(${profile.id})</span>
                        </div>
                    </label>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        async function toggleChromeProfile(profileId) {
            const profile = chromeProfiles.find(p => p.id === profileId);
            if (!profile) return;

            profile.enabled = !profile.enabled;

            const enabledIds = chromeProfiles.filter(p => p.enabled).map(p => p.id);

            try {
                await fetch('/api/chrome-profiles', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabledProfileIds: enabledIds })
                });
            } catch (error) {
                console.error('Error updating Chrome profiles:', error);
                profile.enabled = !profile.enabled; // Revert on error
                renderChromeProfiles();
            }
        }

        // Load Chrome profiles on page load
        loadChromeProfiles();

        // ===================================
        // Create Project from Repo Modal
        // ===================================

        // Generate a random pleasant color
        function generateRandomColor() {
            const colors = [
                '#3B82F6', // Blue
                '#10B981', // Emerald
                '#F59E0B', // Amber
                '#EF4444', // Red
                '#8B5CF6', // Violet
                '#EC4899', // Pink
                '#06B6D4', // Cyan
                '#84CC16', // Lime
                '#F97316', // Orange
                '#6366F1', // Indigo
                '#14B8A6', // Teal
                '#A855F7', // Purple
                '#0EA5E9', // Sky
                '#22C55E', // Green
                '#E11D48', // Rose
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // Open the create project modal
        function openCreateProjectModal(repoId, repoName) {
            document.getElementById('create-project-repo-id').value = repoId;
            document.getElementById('create-project-name').value = repoName;
            document.getElementById('create-project-description').value = '';
            document.getElementById('create-project-color').value = generateRandomColor();
            document.getElementById('create-project-modal').classList.add('active');
        }

        // Close the create project modal
        function closeCreateProjectModal() {
            document.getElementById('create-project-modal').classList.remove('active');
        }

        // Handle create project form submission
        document.getElementById('create-project-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const repoId = document.getElementById('create-project-repo-id').value;
            const name = document.getElementById('create-project-name').value.trim();
            const description = document.getElementById('create-project-description').value.trim();
            const color = document.getElementById('create-project-color').value;

            if (!name) {
                alert('Please enter a project name');
                return;
            }

            try {
                // Create the project
                const createResponse = await fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        description: description || null,
                        color
                    })
                });

                if (!createResponse.ok) {
                    const error = await createResponse.json();
                    alert(error.error || 'Failed to create project');
                    return;
                }

                const newProject = await createResponse.json();

                // Link the repo to the new project
                const linkResponse = await fetch(`/api/git-repositories/${repoId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_id: newProject.id
                    })
                });

                if (!linkResponse.ok) {
                    alert('Project created but failed to link to repository');
                }

                closeCreateProjectModal();
                await loadProjects(); // Reload projects and repos
            } catch (error) {
                console.error('Error creating project:', error);
                alert('Failed to create project');
            }
        });

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeCreateProjectModal();
            }
        });

        // Close modal when clicking overlay
        document.getElementById('create-project-modal').addEventListener('click', (e) => {
            if (e.target.id === 'create-project-modal') {
                closeCreateProjectModal();
            }
        });
    </script>
{% endblock %}
