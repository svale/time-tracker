{% extends "layouts/main.njk" %}

{% block title %}Time Tracker - Reports{% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
            <!-- Date Navigation -->
            <div class="date-navigation">
                <div class="date-picker-header">
                    <h2 class="section-title mb-0">Time Chronicle</h2>
                    <p class="section-description mt-1">Browse your activity history</p>
                </div>

                <div class="date-controls">
                    <button id="prev-day" class="date-nav-btn" onclick="navigateDay(-1)">
                        <span>←</span> Previous Day
                    </button>
                    <input type="date" id="date-picker" class="editorial-date-input" onchange="onDatePickerChange()">
                    <button id="next-day" class="date-nav-btn" onclick="navigateDay(1)">
                        Next Day <span>→</span>
                    </button>
                    <button id="today-btn" class="date-nav-btn date-nav-btn--today" onclick="goToToday()">
                        Today
                    </button>
                </div>

                <div class="selected-date-display">
                    <span class="separator-ornament">◆</span>
                    <span id="selected-date-text"></span>
                    <span class="separator-ornament">◆</span>
                </div>
            </div>

            <!-- Project Filter -->
            <div class="filter-section">
                <label for="project-filter">Filter by Project:</label>
                <select id="project-filter" onchange="applyProjectFilter()">
                    <option value="">All Projects</option>
                </select>
            </div>

            <!-- Decorative separator -->
            <div class="section-separator">
                <span class="separator-ornament">◆</span>
            </div>

            <!-- Workday Summary section -->
            <section class="summary-section">
                <h2 class="section-title" id="summary-title">Workday Summary</h2>
                <div id="workday-summary">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>Calculating workday...</p>
                    </div>
                </div>
            </section>

            <!-- Timeline visualization -->
            <section class="timeline-section">
                <div class="section-header">
                    <h2 class="section-title">Hourly Distribution</h2>
                    <p class="section-description">Activity pattern throughout the day</p>
                </div>
                <div class="chart-container">
                    <canvas id="timeline-chart"></canvas>
                </div>
            </section>

            <!-- Activities list -->
            <section class="activities-section">
                <div class="section-header">
                    <h2 class="section-title">Domain Activity Log</h2>
                    <p class="section-description">Tracked sessions from browser history</p>
                </div>
                <div class="activities-container" id="activities-table">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>Loading activity log...</p>
                    </div>
                </div>
            </section>
{% endblock %}

{% block scripts %}
    <script>
        let currentDate = null;
        let currentProjectFilter = '';
        let timelineChart = null;

        // Initialize on page load
        function init() {
            // Check URL for date parameter
            const urlParams = new URLSearchParams(window.location.search);
            const dateParam = urlParams.get('date');

            if (dateParam && isValidDate(dateParam)) {
                currentDate = dateParam;
            } else {
                // Default to today
                currentDate = getTodayString();
            }

            // Set date picker value
            document.getElementById('date-picker').value = currentDate;

            // Load projects for filter
            loadProjects();

            // Load data for current date
            loadData();
        }

        // Get today's date as YYYY-MM-DD string (local timezone)
        function getTodayString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Validate date string format
        function isValidDate(dateString) {
            const regex = /^\d{4}-\d{2}-\d{2}$/;
            if (!regex.test(dateString)) return false;
            const date = new Date(dateString);
            return date instanceof Date && !isNaN(date);
        }

        // Format date for display
        function formatDateDisplay(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Update selected date display
        function updateDateDisplay() {
            document.getElementById('selected-date-text').textContent = formatDateDisplay(currentDate);

            // Update summary title
            const isToday = currentDate === getTodayString();
            document.getElementById('summary-title').textContent =
                isToday ? "Today's Activity" : `Activity on ${formatDateDisplay(currentDate)}`;

            // Disable next button if current date is today or future
            const nextBtn = document.getElementById('next-day');
            const tomorrow = new Date(currentDate + 'T00:00:00');
            tomorrow.setDate(tomorrow.getDate() + 1);
            const year = tomorrow.getFullYear();
            const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
            const day = String(tomorrow.getDate()).padStart(2, '0');
            const tomorrowString = `${year}-${month}-${day}`;

            if (tomorrowString > getTodayString()) {
                nextBtn.disabled = true;
                nextBtn.style.opacity = '0.5';
                nextBtn.style.cursor = 'not-allowed';
            } else {
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
                nextBtn.style.cursor = 'pointer';
            }
        }

        // Set current date and reload data
        function setDate(dateString) {
            currentDate = dateString;
            document.getElementById('date-picker').value = dateString;
            updateDateDisplay();

            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('date', dateString);
            if (currentProjectFilter) {
                url.searchParams.set('project_id', currentProjectFilter);
            }
            window.history.pushState({}, '', url);

            // Load data
            loadData();
        }

        // Navigate to previous/next day
        function navigateDay(offset) {
            const date = new Date(currentDate + 'T00:00:00');
            date.setDate(date.getDate() + offset);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const newDateString = `${year}-${month}-${day}`;

            // Don't allow future dates
            if (newDateString > getTodayString()) {
                return;
            }

            setDate(newDateString);
        }

        // Go to today
        function goToToday() {
            setDate(getTodayString());
        }

        // Handle date picker change
        function onDatePickerChange() {
            const newDate = document.getElementById('date-picker').value;
            if (isValidDate(newDate)) {
                setDate(newDate);
            }
        }

        // Load projects for filter dropdown
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const projects = await response.json();

                const filterSelect = document.getElementById('project-filter');
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    filterSelect.appendChild(option);
                });

                // Check URL for project filter
                const urlParams = new URLSearchParams(window.location.search);
                const projectParam = urlParams.get('project_id');
                if (projectParam) {
                    currentProjectFilter = projectParam;
                    filterSelect.value = projectParam;
                }
            } catch (error) {
                console.error('Error loading projects:', error);
            }
        }

        // Apply project filter
        function applyProjectFilter() {
            currentProjectFilter = document.getElementById('project-filter').value;

            // Update URL
            const url = new URL(window.location);
            if (currentProjectFilter) {
                url.searchParams.set('project_id', currentProjectFilter);
            } else {
                url.searchParams.delete('project_id');
            }
            window.history.pushState({}, '', url);

            // Reload data
            loadData();
        }

        // Load all data for current date
        async function loadData() {
            updateDateDisplay();
            await Promise.all([
                loadWorkdaySummary(),
                loadActivities(),
                loadTimeline()
            ]);
        }

        // Load workday summary data
        async function loadWorkdaySummary() {
            const container = document.getElementById('workday-summary');
            container.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Calculating workday...</p>
                </div>
            `;

            try {
                const url = `/api/workday-stats?date=${currentDate}`;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                renderWorkdaySummary(container, data);
            } catch (error) {
                console.error('Error loading workday summary:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-ornament">◇</div>
                        <p class="empty-message">Failed to load workday summary</p>
                    </div>
                `;
            }
        }

        function renderWorkdaySummary(container, data) {
            if (!data.has_sufficient_data) {
                const isToday = currentDate === getTodayString();
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-ornament">◇</div>
                        <p class="empty-message">No significant activity recorded on this date.</p>
                        ${isToday ? '<p class="empty-hint">Browser history is checked every 5 minutes. Significant activity (>5 min) needed.</p>' : ''}
                    </div>
                `;
                return;
            }

            // Workday header stats
            let html = `
                <div class="workday-header">
                    <div class="workday-stat">
                        <div class="workday-stat-value">${data.workday_start_formatted || '—'}</div>
                        <div class="workday-stat-label">Started</div>
                    </div>
                    <div class="workday-stat">
                        <div class="workday-stat-value">${data.workday_end_formatted || '—'}</div>
                        <div class="workday-stat-label">Ended</div>
                    </div>
                    <div class="workday-stat">
                        <div class="workday-stat-value">${data.total_time}</div>
                        <div class="workday-stat-label">Total Active</div>
                    </div>
                </div>
            `;

            // Timeline visualization
            if (data.timeline_slots && data.timeline_slots.length > 0) {
                html += `<div class="workday-timeline">`;
                html += `<div class="timeline-slots">`;

                data.timeline_slots.forEach((slot, index) => {
                    const showLabel = index === 0 || index === data.timeline_slots.length - 1 || index % 2 === 0;
                    let barStyle = 'background: var(--color-cream);';

                    if (slot.activities && slot.activities.length > 0) {
                        // Use the dominant project color or mix
                        const totalFill = slot.activities.reduce((sum, a) => sum + a.fill_percent, 0);
                        const dominantActivity = slot.activities.reduce((prev, curr) =>
                            (prev.fill_percent > curr.fill_percent) ? prev : curr
                        );
                        const color = dominantActivity.project_color || '#9CA3AF';
                        const opacity = Math.min(totalFill / 100, 1);
                        barStyle = `background: ${color}; opacity: ${0.4 + (opacity * 0.6)};`;
                    }

                    html += `
                        <div class="timeline-slot">
                            <div class="timeline-slot-bar" style="${barStyle}" title="${slot.time}"></div>
                            ${showLabel ? `<div class="timeline-slot-label">${slot.time}</div>` : '<div class="timeline-slot-label"></div>'}
                        </div>
                    `;
                });

                html += `</div></div>`;
            }

            // Project breakdown
            if (data.project_breakdown && data.project_breakdown.length > 0) {
                html += `<div class="project-breakdown">`;
                data.project_breakdown.forEach(project => {
                    const hours = Math.floor(project.seconds / 3600);
                    const minutes = Math.floor((project.seconds % 3600) / 60);
                    const timeStr = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;

                    html += `
                        <div class="project-chip">
                            <div class="project-chip-color" style="background: ${project.project_color};"></div>
                            <span>${escapeHtml(project.project_name)}</span>
                            <span style="color: var(--color-warm-gray); font-family: var(--font-mono); font-size: 0.8rem;">${timeStr}</span>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            container.innerHTML = html;
        }

        // Load activities data
        async function loadActivities() {
            const activitiesTable = document.getElementById('activities-table');
            activitiesTable.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Loading activity log...</p>
                </div>
            `;

            try {
                let url = `/api/daily-report?date=${currentDate}`;
                if (currentProjectFilter) {
                    url += `&project_id=${currentProjectFilter}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.activities.length === 0) {
                    const isToday = currentDate === getTodayString();
                    activitiesTable.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-ornament">◇</div>
                            <p class="empty-message">No activity recorded on this date.</p>
                            ${isToday ? '<p class="empty-hint">Browser history is checked every 5 minutes.</p>' : ''}
                        </div>
                    `;
                    return;
                }

                let html = '<div class="activities-list">';

                data.activities.forEach((activity, index) => {
                    const displayName = activity.domain || activity.app_name;
                    const browserName = activity.app_name;
                    const animationDelay = index * 0.05;

                    // Project badge HTML
                    let projectBadge = '';
                    if (activity.project_name && activity.project_color) {
                        projectBadge = `
                            <span class="project-badge" style="background-color: ${activity.project_color};">
                                ${escapeHtml(activity.project_name)}
                            </span>
                        `;
                    }

                    // Page title HTML (take first title if multiple, truncate if too long)
                    let pageTitleHtml = '';
                    if (activity.page_titles) {
                        const firstTitle = activity.page_titles.split(',')[0].trim();
                        const truncatedTitle = truncate(firstTitle, 60);
                        pageTitleHtml = `<div class="activity-title" title="${escapeHtml(firstTitle)}">${escapeHtml(truncatedTitle)}</div>`;
                    }

                    html += `
                        <div class="activity-entry" style="animation-delay: ${animationDelay}s">
                            <div class="activity-main">
                                <div class="activity-domain">
                                    ${escapeHtml(displayName)}
                                    ${projectBadge}
                                </div>
                                ${pageTitleHtml}
                                <div class="activity-browser">${escapeHtml(browserName)}</div>
                            </div>
                            <div class="activity-stats">
                                <div class="activity-time">${activity.time}</div>
                                <div class="activity-sessions">${activity.session_count} session${activity.session_count !== 1 ? 's' : ''}</div>
                            </div>
                            <div class="activity-bar">
                                <div class="activity-bar-fill" style="width: ${activity.percentage}%"></div>
                                <div class="activity-percentage">${activity.percentage}%</div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                activitiesTable.innerHTML = html;
            } catch (error) {
                console.error('Error loading activities:', error);
                activitiesTable.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-ornament">◇</div>
                        <p class="empty-message">Failed to load activity data</p>
                    </div>
                `;
            }
        }

        // Load timeline data
        async function loadTimeline() {
            try {
                let url = `/api/timeline?date=${currentDate}`;
                if (currentProjectFilter) {
                    url += `&project_id=${currentProjectFilter}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                updateTimelineChart(data);
            } catch (error) {
                console.error('Error loading timeline:', error);
            }
        }

        // Update timeline chart
        function updateTimelineChart(data = null) {
            const ctx = document.getElementById('timeline-chart');
            if (!ctx) return;

            // Destroy existing chart
            if (timelineChart) {
                timelineChart.destroy();
            }

            // Prepare data
            const hours = [];
            const values = [];

            if (data && data.timeline && data.timeline.length > 0) {
                data.timeline.forEach(item => {
                    hours.push(item.hour);
                    values.push(item.minutes || 0); // Already in minutes from API
                });
            } else {
                // Empty state - show 24 hours with 0 values
                for (let i = 0; i < 24; i++) {
                    hours.push(`${String(i).padStart(2, '0')}:00`);
                    values.push(0);
                }
            }

            // Create chart
            timelineChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Minutes',
                        data: values,
                        backgroundColor: 'rgba(197, 90, 71, 0.7)',
                        borderColor: 'rgba(197, 90, 71, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 3,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Minutes'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hour'
                            }
                        }
                    }
                }
            });
        }

        // Truncate text to max length
        function truncate(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize on page load - wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            // DOM is already loaded
            init();
        }
    </script>
{% endblock %}
